<style>
label {
    display: inline-block;
    margin: .5rem 0 0 0;
    float: left;
}
.list {
    position: absolute;
}
.list-open {
    z-index: 10000;
    background-color: #fafafa;
    border: 1px solid #eeeeee;
}
.rth {
    vertical-align: bottom;
}
.saving {
    border-color: green;
    border-width: 2px;
}
.btns, .inline {
    display: inline-block;
}
.icon8 {
    padding: 3px;
    margin: 3px;
    cursor: pointer;
}
.ileft {
    margin-left:-12px;
}
.iright {
    margin-right:-12px;
}
.t-selected {
    margin-top: 3px;
}
#ShowReport {
    overflow-y: scroll;
}
</style>
<div class="t9n">
<div id="show" class="list">
<a id="showanchor" onclick="if(json['list']){byId('queries').classList.remove('hidden');byId('show').classList.add('hidden')}else myApi('GET','object/22/?JSON','list')"><img class="icon8" title="<t9n>[RU]Список запросов[EN]Reports list</t9n>" src="https://img.icons8.com/ios/25/222222/list.png"></a>
</div>
<div id="queries" class="list list-open shadow p-3 hidden" onclick="event.stopPropagation?event.stopPropagation():(event.cancelBubble=true);">
<p>
    <t9n>[RU]Выберите запрос или добавьте новый[EN]Pick the report or add a new one</t9n>
    <a id="closeList" onclick="byId('queries').classList.add('hidden');byId('show').classList.remove('hidden')">
        &nbsp;&nbsp;&nbsp;&nbsp;<img class="icon8" title="<t9n>[RU]Скрыть список запросов[EN]Hide the reports list</t9n>" src="https://img.icons8.com/ios/25/222222/close-window.png">
    </a>
</p>
<div>
<form method="post" action="/{_global_.z}/_m_new/22?up=1" onsubmit="addbtn.disabled=true; return true;">
    <input type="hidden" name="_xsrf" value="{_global_.xsrf}">
    <input type="hidden" name="next_act" value="{_global_.action}">
    <table>
    <tr>
    	<td><input placeholder="<t9n>[RU]Поиск / Новый запрос[EN]Seek or add new</t9n>" type="text" name="t22" class="form-control form-control-sm" autocomplete="off" onkeyup="seekRep(this.value)"></td>
    	<td><input type="submit" name="addbtn" class="btn btn-primary btn-sm" value="<t9n>[RU]Создать запрос[EN]Create a query</t9n>"></td>
    </tr>
    </table>
</form>
</div>
<br/>
<div id="list">
    <p><a target="_rep{_global_.id}" href="/{_global_.z}/report/:id:">:val:</a> 
     <a target="_rep{_global_.id}"  href="/{_global_.z}/smartq/:id:"><svg width="28" height="28" viewBox="0 0 28 28" class="ml-2" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M6 24H23M18 4L22 8L11 19H7V15L18 4Z" stroke="#666666" stroke-linecap="round" stroke-linejoin="round"/>
    </svg></a>
     <a  href="/{_global_.z}/sql/:id:"><svg width="24" height="24" viewBox="0 0 24 24" class="ml-2" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 14.5714C13.4201 14.5714 14.5714 13.4201 14.5714 12C14.5714 10.5798 13.4201 9.42855 12 9.42855C10.5798 9.42855 9.42855 10.5798 9.42855 12C9.42855 13.4201 10.5798 14.5714 12 14.5714Z" stroke="#666666" stroke-linecap="round" stroke-linejoin="round"></path>
    <path d="M18.3428 14.5714C18.2287 14.8299 18.1947 15.1167 18.2451 15.3948C18.2955 15.6728 18.4281 15.9294 18.6257 16.1314L18.6771 16.1828C18.8365 16.3421 18.963 16.5311 19.0492 16.7392C19.1355 16.9473 19.1799 17.1704 19.1799 17.3957C19.1799 17.621 19.1355 17.8441 19.0492 18.0522C18.963 18.2603 18.8365 18.4493 18.6771 18.6086C18.5179 18.7679 18.3288 18.8944 18.1207 18.9807C17.9126 19.0669 17.6896 19.1113 17.4643 19.1113C17.239 19.1113 17.0159 19.0669 16.8078 18.9807C16.5997 18.8944 16.4106 18.7679 16.2514 18.6086L16.2 18.5571C15.998 18.3595 15.7414 18.227 15.4633 18.1766C15.1853 18.1261 14.8985 18.1602 14.64 18.2743C14.3865 18.3829 14.1703 18.5633 14.018 18.7933C13.8657 19.0233 13.7839 19.2927 13.7828 19.5686V19.7143C13.7828 20.1689 13.6022 20.605 13.2807 20.9265C12.9592 21.2479 12.5232 21.4286 12.0686 21.4286C11.6139 21.4286 11.1779 21.2479 10.8564 20.9265C10.5349 20.605 10.3543 20.1689 10.3543 19.7143V19.6371C10.3476 19.3534 10.2558 19.0783 10.0907 18.8474C9.92561 18.6166 9.6949 18.4408 9.42855 18.3428C9.17003 18.2287 8.88325 18.1947 8.60519 18.2451C8.32714 18.2955 8.07056 18.4281 7.86855 18.6257L7.81713 18.6771C7.65791 18.8365 7.46885 18.963 7.26074 19.0492C7.05263 19.1355 6.82955 19.1799 6.60427 19.1799C6.37898 19.1799 6.15591 19.1355 5.9478 19.0492C5.73969 18.963 5.55062 18.8365 5.39141 18.6771C5.23202 18.5179 5.10558 18.3288 5.01931 18.1207C4.93304 17.9126 4.88863 17.6896 4.88863 17.4643C4.88863 17.239 4.93304 17.0159 5.01931 16.8078C5.10558 16.5997 5.23202 16.4106 5.39141 16.2514L5.44284 16.2C5.64044 15.998 5.773 15.7414 5.82341 15.4633C5.87383 15.1853 5.8398 14.8985 5.7257 14.64C5.61704 14.3865 5.43663 14.1703 5.20667 14.018C4.9767 13.8657 4.70723 13.7839 4.43141 13.7828H4.2857C3.83104 13.7828 3.395 13.6022 3.07351 13.2807C2.75202 12.9592 2.57141 12.5232 2.57141 12.0686C2.57141 11.6139 2.75202 11.1779 3.07351 10.8564C3.395 10.5349 3.83104 10.3543 4.2857 10.3543H4.36284C4.64655 10.3476 4.9217 10.2558 5.15252 10.0907C5.38335 9.92561 5.55917 9.6949 5.65713 9.42855C5.77122 9.17003 5.80526 8.88325 5.75484 8.60519C5.70443 8.32714 5.57187 8.07056 5.37427 7.86855L5.32284 7.81713C5.16345 7.65791 5.03701 7.46885 4.95074 7.26074C4.86447 7.05263 4.82006 6.82955 4.82006 6.60427C4.82006 6.37898 4.86447 6.15591 4.95074 5.9478C5.03701 5.73969 5.16345 5.55062 5.32284 5.39141C5.48205 5.23202 5.67112 5.10558 5.87923 5.01931C6.08734 4.93304 6.31041 4.88863 6.5357 4.88863C6.76098 4.88863 6.98405 4.93304 7.19217 5.01931C7.40028 5.10558 7.58934 5.23202 7.74855 5.39141L7.79998 5.44284C8.00199 5.64044 8.25857 5.773 8.53662 5.82341C8.81467 5.87383 9.10145 5.8398 9.35998 5.7257H9.42855C9.68207 5.61704 9.89828 5.43663 10.0506 5.20667C10.2029 4.9767 10.2846 4.70723 10.2857 4.43141V4.2857C10.2857 3.83104 10.4663 3.395 10.7878 3.07351C11.1093 2.75202 11.5453 2.57141 12 2.57141C12.4546 2.57141 12.8907 2.75202 13.2122 3.07351C13.5337 3.395 13.7143 3.83104 13.7143 4.2857V4.36284C13.7154 4.63866 13.7971 4.90813 13.9494 5.1381C14.1017 5.36806 14.3179 5.54847 14.5714 5.65713C14.8299 5.77122 15.1167 5.80526 15.3948 5.75484C15.6728 5.70443 15.9294 5.57187 16.1314 5.37427L16.1828 5.32284C16.3421 5.16345 16.5311 5.03701 16.7392 4.95074C16.9473 4.86447 17.1704 4.82006 17.3957 4.82006C17.621 4.82006 17.8441 4.86447 18.0522 4.95074C18.2603 5.03701 18.4493 5.16345 18.6086 5.32284C18.7679 5.48205 18.8944 5.67112 18.9807 5.87923C19.0669 6.08734 19.1113 6.31041 19.1113 6.5357C19.1113 6.76098 19.0669 6.98405 18.9807 7.19217C18.8944 7.40028 18.7679 7.58934 18.6086 7.74855L18.5571 7.79998C18.3595 8.00199 18.227 8.25857 18.1766 8.53662C18.1261 8.81467 18.1602 9.10145 18.2743 9.35998V9.42855C18.3829 9.68207 18.5633 9.89828 18.7933 10.0506C19.0233 10.2029 19.2927 10.2846 19.5686 10.2857H19.7143C20.1689 10.2857 20.605 10.4663 20.9265 10.7878C21.2479 11.1093 21.4286 11.5453 21.4286 12C21.4286 12.4546 21.2479 12.8907 20.9265 13.2122C20.605 13.5337 20.1689 13.7143 19.7143 13.7143H19.6371C19.3613 13.7154 19.0918 13.7971 18.8619 13.9494C18.6319 14.1017 18.4515 14.3179 18.3428 14.5714Z" stroke="#666666" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg></a>
</p>
</div>
</div>
</div>
<div id="one" class="hidden mt-3" onclick="hideList()">
    <center>
        <h4 class="ml-5 t9n">
            <a target=":id:" href="/{_global_.z}/report/{_global_.id}">:val:</a>&nbsp;
            <a target=":id:" href="/{_global_.z}/smartq/{_global_.id}" title="<t9n>[RU]Редактируемый отчет[EN]Editable report</t9n>">
                <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 24H23M18 4L22 8L11 19H7V15L18 4Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
                </svg></a>&nbsp;
            <a target=":id:" href="/{_global_.z}/edit_obj/{_global_.id}#t22" title="<t9n>[RU]Редактировать остальные свойства запроса[EN]Edit the rest of the query properties</t9n>">
                <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="btn-svg">
                <path d="M22 16.66V22C22 22.5304 21.7893 23.0391 21.4142 23.4142C21.0391 23.7893 20.5304 24 20 24H6C5.46957 24 4.96086 23.7893 4.58579 23.4142C4.21071 23.0391 4 22.5304 4 22V8C4 7.46957 4.21071 6.96086 4.58579 6.58579C4.96086 6.21071 5.46957 6 6 6H11.34M20 4L24 8L14 18H10V14L20 4Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
                </svg></a>&nbsp;
            <a href="#" onclick="copyLink('report/{_global_.id}')" title="<t9n>[RU]Копировать путь для использования в шаблонах Интеграла[EN]Copy the path to use in templates within IdeaV</t9n>">
                <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="btn-svg">
                <path d="M11.9436 14.9336C12.373 15.5077 12.9209 15.9827 13.5501 16.3265C14.1793 16.6703 14.8751 16.8747 15.5902 16.9259C16.3054 16.9771 17.0231 16.8739 17.6949 16.6233C18.3667 16.3728 18.9767 15.9806 19.4836 15.4736L22.4836 12.4736C23.3944 11.5305 23.8983 10.2675 23.8869 8.95655C23.8755 7.64557 23.3497 6.39151 22.4227 5.46447C21.4956 4.53743 20.2415 4.01158 18.9306 4.00019C17.6196 3.9888 16.3566 4.49277 15.4136 5.40356L13.6936 7.11356M15.9436 12.9336C15.5141 12.3594 14.9662 11.8844 14.337 11.5406C13.7078 11.1969 13.0121 10.9924 12.2969 10.9412C11.5818 10.89 10.864 10.9932 10.1922 11.2438C9.52045 11.4944 8.91044 11.8865 8.40356 12.3936L5.40356 15.3936C4.49277 16.3366 3.9888 17.5996 4.00019 18.9106C4.01158 20.2216 4.53743 21.4756 5.46447 22.4027C6.39151 23.3297 7.64557 23.8555 8.95655 23.8669C10.2675 23.8783 11.5305 23.3744 12.4736 22.4636L14.1836 20.7536" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
                </svg></a>&nbsp;
            <a href="#" onclick="copyLink('https://'+location.host+'/{_global_.z}/report/{_global_.id}')" title="<t9n>[RU]Копировать абсолютный путь для раздачи вовне[EN]Copy the full path to open from anywhere</t9n>">
                <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="btn-svg">
                <path d="M18 6H20C20.5304 6 21.0391 6.21071 21.4142 6.58579C21.7893 6.96086 22 7.46957 22 8V22C22 22.5304 21.7893 23.0391 21.4142 23.4142C21.0391 23.7893 20.5304 24 20 24H8C7.46957 24 6.96086 23.7893 6.58579 23.4142C6.21071 23.0391 6 22.5304 6 22V8C6 7.46957 6.21071 6.96086 6.58579 6.58579C6.96086 6.21071 7.46957 6 8 6H10M11 4H17C17.5523 4 18 4.44772 18 5V7C18 7.55228 17.5523 8 17 8H11C10.4477 8 10 7.55228 10 7V5C10 4.44772 10.4477 4 11 4Z" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
                </svg></a>&nbsp;
            <span id="copied" style="display:none; color:gray; position:absolute" class="text-nowrap"><t9n>[RU]Скопировано[EN]Copied</t9n></span>
        </h4>
    </center>
    <div class="container-fluid">
        <div class="row">
            <div class="col" style="height:12px">
            </div>
        </div>
        <div class="row">
            <div class="col-6 col-md-2 col-lg-2 col-xl-2 mb-1">
                <br /><nobr><label class="mt-0"><img id="interactWait" class="hidden" src="/i/ajax.gif"><input type="checkbox" id="interact" onchange="setInteract()" value="1">&nbsp;<t9n>[RU]Интерактивный[EN]Interactive</t9n></label></nobr>
            </div>
            <div class="col-6 col-md-2 col-lg-2 col-xl-1 mb-1 pr-1">
                <br /><img id="limitWait" class="hidden" src="/i/ajax.gif"><input class="form-control form-control-sm" type="text" id="limit" onchange="setLimit(this.valur)" placeholder="LIMIT">
            </div>
            <div class="col-12 col-md-8 col-lg-8 col-xl-6 pl-1">
                <br />
                <button class="btn btn-outline-secondary btn-sm mb-1" id="102" onclick="showCtl(this)"><t9n>[RU]Фильтр[EN]Filter</t9n></button>
                <button class="btn btn-outline-secondary btn-sm mb-1" id="84" onclick="showCtl(this)"><t9n>[RU]Формат[EN]Format</t9n></button>
                <button class="btn btn-outline-secondary btn-sm mb-1" id="104" onclick="showCtl(this)"><t9n>[RU]Функция[EN]Function</t9n></button>
                <button class="btn btn-outline-secondary btn-sm mb-1" id="109" onclick="showCtl(this)"><t9n>[RU]Сортировка[EN]Order</t9n></button>
                <button class="btn btn-outline-secondary btn-sm mb-1" id="72" onclick="showCtl(this)"><t9n>[RU]Итоги[EN]Totals</t9n></button>
                <button class="btn btn-outline-secondary btn-sm mb-1" id="101" onclick="showCtl(this)"><t9n>[RU]Формула[EN]Expression</t9n></button>
                <button class="btn btn-outline-secondary btn-sm mb-1" id="105" onclick="showCtl(this)"><t9n>[RU]HAVING[EN]HAVING</t9n></button>
                <button class="btn btn-outline-secondary btn-sm mb-1" id="132" onclick="showCtl(this)"><t9n>[RU]SET[EN]SET</t9n></button>
                <!--<button class="btn btn-outline-secondary btn-sm mb-1" id="58" onclick="showCtl(this)"><t9n>[RU]ALIAS[EN]ALIAS</t9n></button>-->
            </div>
            <div class="col-12 col-md-12 col-lg-12 col-xl-3 mb-1">
                <t9n>[RU]Добавить колонку или[EN]Add a column or</t9n> <a href="#" onclick="addCol(0)"><t9n>[RU]вычисляемое[EN]calculatable</t9n></a><br>
                <div class="input-group input-group-sm">
                    <span class="t-selected table-column" style="display:none;"></span>
            		<select id="table" class="form-control table-column" onchange="if(this.value.length)selectTable(this.value)">
            			<option id=":id:" value=":id:">:val:</option>
            		</select>
            		<div class="input-group-append t9n">
            		    <img id="addColWait" style="display:none;" src="/i/ajax.gif">
            		    <a onclick="$('.table-column').toggle()" class="table-column" title="<t9n>[RU]Выбрать другую таблицу[EN]Choose another table</t9n>" style="display:none;">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12.5714 12.5714L19.4286 19.4285M19.4286 12.5714L12.5714 19.4285" stroke="#1A1A1A" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </a>
                    </div>
            		<select id="t28" class="form-control table-column" onchange="if(this.value.length)addCol(this.value)" style="display:none;">
            		</select>
                </div>
            </div>
        </div>
    </div>
    <div id="warning" class="alert alert-warning hidden" role="alert"></div>
    <div id="ShowReport"></div>
</div>
<div class="hidden t9n" id="controls">
    <div id="template102">
		<input type="text" id="t102_:id:" value="" placeholder="<t9n>[RU]От[EN]Filter from</t9n>" class="form-control form-control-sm save-input">
		<div id="dd102_:id:"></div>
		<input type="text" id="t103_:id:" value="" placeholder="<t9n>[RU]До[EN]Filter to</t9n>" class="form-control form-control-sm save-input">
		<div id="dd103_:id:"></div>
	</div>
    <div id="template104"><!--Функция-->
        <select name="t104" id="t104_:id:" class="form-control form-control-sm onchange">
			    <option> </option>
				<option value="98" r="104">abn_BT</option>
				<option value="89" r="104">abn_DATE2STR</option>
				<option value="85" r="104">abn_ID</option>
				<option value="90" r="104">abn_NUM2STR</option>
				<option value="93" r="104">abn_ORD</option>
				<option value="88" r="104">abn_REQ</option>
				<option value="92" r="104">abn_ROWNUM</option>
				<option value="87" r="104">abn_TYP</option>
				<option value="86" r="104">abn_UP</option>
				<option value="91" r="104">abn_URL</option>
				<option value="77" r="104">AVG</option>
				<option value="74" r="104">COUNT</option>
				<option value="75" r="104">MAX</option>
				<option value="76" r="104">MIN</option>
				<option value="235" r="104">GROUP_CONCAT</option>
				<option value="141" r="104">MONTH</option>
				<option value="140" r="104">ROUND</option>
				<option value="73" r="104">SUM</option>
				<option value="142" r="104">YEAR</option>
		</select>
	</div>
	<div id="template84"><!--Формат-->
	    <select name="t84" id="t84_:id:" class="form-control form-control-sm onchange">
		    <option> </option>
			<option value="78" r="84">DATE</option>
			<option value="34" r="84">HTML</option>
			<option value="81" r="84">NUMBER</option>
			<option value="82" r="84">PATH</option>
			<option value="79" r="84">SHORT</option>
			<option value="80" r="84">SIGNED</option>
		</select>
    </div>
    <div id="template72"><!--Итог-->
	    <select name="t72" id="t72_:id:" class="form-control form-control-sm onchange">
		    <option> </option>
			<option value="68" r="72">AVG</option>
			<option value="71" r="72">COUNT</option>
			<option value="70" r="72">MAX</option>
			<option value="69" r="72">MIN</option>
			<option value="67" r="72">SUM</option>
		</select>
	</div>
    <div id="template105"><!--Having-->
		<input type="text" id="t105_:id:" value="" placeholder="<t9n>[RU]От[EN]Having: from</t9n>" class="form-control form-control-sm save-input">
		<input type="text" id="t106_:id:" value="" placeholder="<t9n>[RU]до[EN]Having: to</t9n>" class="form-control form-control-sm save-input">
	</div>
    <div id="template109"><!--Order-->
		
	</div>
    <div id="template101"><!--Expression-->
		<input type="text" name="t101" id="t101_:id:" class="form-control form-control-sm save-input" value="">
	</div>
    <div id="date_dd"><!--Date DD-->
    	<ul class="dropdown-menu">
            <li class="p-2"><a onclick="curEl.value='[TODAY]';updateValue(curEl)">[TODAY] – <t9n>[RU]текущий день[EN]Current date</t9n></a></li>
            <li class="p-2"><a onclick="curEl.value='[YESTERDAY]';updateValue(curEl)">[YESTERDAY] – <t9n>[RU]вчерашний день[EN]yesterday</t9n></a></li>
            <li class="p-2"><a onclick="curEl.value='[TOMORROW]';updateValue(curEl)">[TOMORROW] – <t9n>[RU]завтрашний день.[EN]tomorrow date</t9n></a></li>
            <li class="p-2"><a onclick="curEl.value='[MONTH_AGO]';updateValue(curEl)">[MONTH_AGO] – <t9n>[RU]день месяц назад[EN]a day a month ago</t9n></a></li>
            <li class="p-2"><a onclick="curEl.value='';updateValue(curEl)"><img class="icon8 p-0" src="https://img.icons8.com/ios/20/dd0000/delete-sign.png"/> <t9n>[RU]Очистить[EN]Clean</t9n></a></li>
        </ul>
	</div>
    <div id="template58"><!--Alias-->
		<input type="text" name="t58" id="t58_:id:" class="form-control form-control-sm save-input" value="">
	</div>
    <div id="template132"><!--Set-->
		<input type="text" name="t132" id="t132_:id:" class="form-control form-control-sm save-input" value="">
	</div>
</div>
<script>
var timer,repList=byId('list').innerHTML,lastK;
function selectTable(v){
    var i,h=colListTemplate.replace(/:id:/g,'')
                            .replace(':val:',t9n('[RU]выберите колонку[EN]Select the column'));
    for(i in json.select.rep_col_list)
        if(json.select.rep_col_list[i].table===v)
            h+=colListTemplate.replace(/:id:/g,json.select.rep_col_list[i].id)
                            .replace(':val:',json.select.rep_col_list[i].name);
    $('#t28').html(h);
    if($('#t28').find('option[value]').length===2)
        addCol($('#t28').find('option[value]')[1].id);
    $('.t-selected').html(getTableName(v));
    $('.table-column').toggle();
    $('#t28').focus();
}
function getTableName(v){
    for(i in json.select.rep_col_list)
        if(json.select.rep_col_list[i].table===v)
            return json.select.rep_col_list[i].name;
}
function copyLink(i){
    var $temp = $("<input>");
    $("body").append($temp);
    $temp.val(i).select();
    document.execCommand("copy");
    $temp.remove();
    $('#copied').show().delay(2500).slideUp(400);
}
function seekRep(v){
    if(lastK==v) return;
    lastK=v;
    window.clearTimeout(timer);
    if(v.length>0){
        if(v.substring(0,1)!='@'&&v.substring(0,1)!='!')
            v='%25'+v+'%25';
        timer=setTimeout(function(){myApi('GET','object/22/?JSON&F_22='+v,'list')},330);
    }
}
function hideList(){
    if(!byId('queries').classList.contains('hidden'))
        byId('closeList').click();
}
function showCtl(el){ // Mark buttons pressed in case they were pressed before the last action
    i='r'+el.id;
    if(byId(i).classList.contains('hidden')){
        byId(i).classList.remove('hidden');
        el.classList.add('active')
    }
    else{
        byId(i).classList.add('hidden');
        el.classList.remove('active')
    }
}
function setInteract(){ // Set Interactive mark and save it's value
    byId('interactWait').classList.remove('hidden');
    byId('interact').classList.add('hidden');
    myApi('POST','_m_set/{_global_.id}?JSON&t95='+(interact?'':1),'interact');
}
function setLimit(){ // Set Interactive mark and save it's value
    byId('limitWait').classList.remove('hidden');
    byId('limit').classList.add('hidden');
    myApi('POST','_m_set/{_global_.id}?JSON&t134='+($('#limit').val()),'interact');
}
function addCol(val){ // Add a column to the report
    $('.table-column,#addColWait').toggle();
    // Prevent creating duplicate names, use Name1, Name2, ...
    var j=1,seek=true,a=alias[val];
    while(seek){
        seek=false;
        for(i in colNames)
            if(colNames[i]==a){
                a+=(j++);
                seek=true;
                break;
            }
    }
    myApi('POST','_m_new/28?JSON&up={_global_.id}&t28='+val+'&t100='+a,'addCol');
}
function getReq(id,r){
    if(json['select'].reqs)
        if(json['select'].reqs[id]!==undefined)
            if(json['select'].reqs[id][r]!==undefined)
                return json['select'].reqs[id][r].replace(/"/gm,'&quot;');
    return '';
}
function align(i){
    switch(i){
		case 'PWD':
		case 'DATE':
		case 'BOOLEAN':
			return 'CENTER';
		case 'NUMBER':
		case 'SIGNED':
			return 'RIGHT';
	}
	return 'LEFT';
}
// Функция для отправки асинхронного запроса по https api с обработкой его результата
function myApi(m,u,b,vars,index){ // Параметры: метод, адрес, действие - ветка switch, параметры
    vars=vars||''; // По умолчанию список параметров пуст
    var h='',i,j,er='',obj=new XMLHttpRequest(); // Объявляем переменную под JSON и API по HTTPS
    json[u]=[];
    obj.open(m,'/'+db+'/'+u,true); // Открываем асинхронное соединение заданным методом по нужному адресу
    if(m=='POST'){ // Если это POST запрос, то передаем заданные параметры
        obj.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
        vars='_xsrf='+xsrf+'&'+vars; // добавляем токен xsrf, необходимый для POST-запроса
        obj.send(vars); // отправляем параметры
    }
    else
        obj.send(); // отправили запрос и теперь будем ждать ответ, а пока - выходим
    obj.onload=function(e){ // Когда запрос вернет результат - сработает эта функция
        try{ // в this.responseText лежит ответ от сервера
            json[b]=JSON.parse(this.responseText); // Пытаемся разобрать ответ как JSON
        }
        catch(e){ // Если произошла ошибка при разборе JSON
            console.log(e); // то выводим детали этой ошибки в консоль браузера
            console.log(er=this.responseText);
        }
        obj.abort(); // Закрываем соединение
        switch(b){ // Отрабатываем заданную команду - переходим в соответствующую ветку case
            case 'addCol':
                $('#addColWait').hide();
            case 'd':
                go();
                break;
            case 'setOrder': // Wait until all orders are updated
                ordersCount--;
                if(ordersCount===0)
                    go();
                break;
            case 'ctls': // Controls were updated - Filter, Function, Totals, etc.
                myApi('GET','report/{_global_.id}?LIMIT=25&JSON','ShowReport');
            case 'updateCol': // Update a column name - alias
                if(byId(index))
                    byId(index).classList.remove('saving');
                break;
            case 'interact':
                $('#interactWait,#limitWait').addClass('hidden');
                $('#interact,#limit').removeClass('hidden');
                go();
                break;
            case 'list': 
                if(json[b].object){
                    for(i in json[b].object)
                        h+=repList.replace(/:id:/g,json[b].object[i].id).replace(':val:',json[b].object[i].val);
                    byId('list').innerHTML=h;
                }
                else
                    byId('list').innerHTML=t9n('[RU]Не найдено[EN]Found nothing');
                byId('queries').classList.remove('hidden');
                byId('show').classList.add('hidden');
                break;
            case 'one': // Get the info on the requested report
                if(json[b]['obj']){
                    byId('one').innerHTML=byId('one').innerHTML.replace(/:id:/g,json[b]['obj'].id)
                                                                .replace(':val:',json[b]['obj'].val);
                    byId('one').classList.remove('hidden');
                    byId('interact').checked=interact=(json[b]['reqs'][95]['value']!="");
                    $('#limit').val(json[b]['reqs'][134]['value']);
                    myApi('GET','object/28/?F_U={_global_.id}&JSON&LIMIT=1000','select');
                }
                break;
            case 'select': // Get the info on the requested report's columns
                if(json[b]['type']){
                    var hcolor,htitle,id,dir,order,l='',hide,c=[],control;
                    for(k in ctl)
                        c[k]='';
                    j=0;
                    for(i in json[b].object){
                        id=json[b].object[i].id;
                        // The report table header
                        h+='<td class="rth pt-2 pl-2 pr-2"><center><div id="'+id+'">'+drawCol(id)+'</div>';
                        // Hidden/non-hidden fields
                        if(getReq(id,107)===''){
                            hcolor='aaaaaa';
                            htitle=t9n('[RU]Кликните, чтобы скрыть колонку в отчете[EN]Click to hide this column in the report');
                            l+='<td align=":align'+j+':">:'+j+':</td>'; // a non-hidden report line
                            j++;
                            t107=1;
                        }
                        else{
                            hcolor='222222';
                            htitle=t9n('[RU]Скрытое поле[EN]Hidden column. Click to unhide');
                            l+='<td> </td>' // a hidden report line
                            t107='';
                        }
                        // Buttons under the column name
                        h+='<nobr><img class="icon8 ileft" onclick="this.src=\'/i/ajax.gif\';d(\'up\','+id+')" src="https://img.icons8.com/ios/25/aaaaaa/chevron-left.png" title="'
                                +t9n('[RU]Переместить колонку левее[EN]Move the column left')+'">'
                            +'<img class="icon8" onclick="this.src=\'/i/ajax.gif\';d(\'set\','+id+',\'t107='+t107+'\')" src="https://img.icons8.com/ios/25/'+hcolor+'/hide.png" title="'+htitle+'">'
                            +'<img class="icon8 iright" onclick="d(\'del\','+id+');colNames['+id+']=undefined" src="https://img.icons8.com/ios/25/aaaaaa/delete.png" title="'
                                +t9n('[RU]Удалить колонку[EN]Delete the column')+'"><nobr></center></td>';
                        // Column control lines: Filter, Function, Totals, etc.
                        for(k in ctl){
                            c[k]+='<td style="border: none;" class="p-0" id="td'+ctl[k]+'_'+id+'">';
                            control=(i==0?byId(ctl[k]).innerHTML:'')+'<br />';
                            control+=byId('template'+ctl[k]).innerHTML.replace(/:t:/g,ctl[k]).replace(/:id:/g,id);
                            if(getReq(id,'ref_'+ctl[k])!=='') // Reference - select input
                                control=control.replace('value="'+getReq(id,'ref_'+ctl[k]).split(':')[1]+'"','value="'+getReq(id,'ref_'+ctl[k]).split(':')[1]+'" selected');
                            else if(ctl[k]==102){ // Range input for Filter
                                control=control.replace('id="t102_'+id+'" value=""','id="t102_'+id+'" value="'+getReq(id,102)+'"')
                                                .replace('id="t103_'+id+'" value=""','id="t103_'+id+'" value="'+getReq(id,103)+'"');
                            }
                            else if(ctl[k]==105){ // Range input for HAVING
                                control=control.replace('id="t105_'+id+'" value=""','id="t105_'+id+'" value="'+getReq(id,105)+'"')
                                                .replace('id="t106_'+id+'" value=""','id="t106_'+id+'" value="'+getReq(id,106)+'"');
                            }
                            else if(ctl[k]==109){ // Order
                                dir=getReq(id,ctl[k]);
                                order=Math.abs(dir);
                                if(dir=='')
                                    control+='<img onclick="this.src=\'/i/ajax.gif\';setOrder('+id+',0,1)" title="'+t9n('[RU]Включить сортировку[EN]Set the order by this column')
                                            +'" class="icon8" src="https://img.icons8.com/ios/25/aaaaaa/generic-sorting-2.png"/>';
                                else{
                                    if(order==1)
                                        control+='<img title="'+t9n('[RU]В первую очередь сортировка по этой колонке[EN]First, the report is ordered by this column')
                                                +'" class="icon8" src="https://img.icons8.com/ios/25/222222/'+order+'.png"/>';
                                    else
                                        control+='<img onclick="this.src=\'/i/ajax.gif\';setOrder('+id+','+dir+','+(order-1)+')" title="'+t9n('[RU]Очередность сортировки. Кликните, чтобы повысить.[EN]Ordering sequence. Click to rise.')
                                                +'" class="icon8" src="https://img.icons8.com/ios/25/222222/'+order+'.png"/>';
                                    if(dir>0)
                                        control+='<img title="'+t9n('[RU]Сортировка по возрастанию. Кликните, чтобы обратить[EN]Ascending order. Click to revert')
                                                +'" onclick="this.src=\'/i/ajax.gif\';d(\'set\','+id+',\'t109='+(-dir)+'\')" class="icon8" src="https://img.icons8.com/ios/25/222222/generic-sorting-2.png"/>';
                                    else
                                        control+='<img title="'+t9n('[RU]Сортировка по убыванию. Кликните, чтобы обратить[EN]Descending order. Click to revert')
                                                +'" onclick="this.src=\'/i/ajax.gif\';d(\'set\','+id+',\'t109='+(-dir)+'\')" class="icon8" src="https://img.icons8.com/ios/25/222222/generic-sorting.png"/>';
                                    control+='<img title="'+t9n('[RU]Удалить сортировку[EN]Remove the ordering')
                                            +'" onclick="this.src=\'/i/ajax.gif\';setOrder('+id+',0,\'\')" class="icon8" src="https://img.icons8.com/ios/25/222222/delete-sign.png"/>';
                                }
                            }
                            else
                                control=control.replace('value=""','value="'+getReq(id,ctl[k]).replace(/"/g,'\"')+'" title="'+getReq(id,ctl[k]).replace(/"/g,'\"')+'"');
                            c[k]+=control+'</td>';
                        }
                    }
                    // Construct the control lines
                    for(k in ctl)
                        c[k]='<tr style="border: 1px" id="r'+ctl[k]+'" class="'+(byId(ctl[k]).classList.contains('active')?'':'hidden')+'">'+c[k]+'</tr>';
                    // The template for the data line
                    rbody='<tr>'+l+'</tr>';
                    // Table: Header (h) + Control lines (c) + Data (rbody as a template)
                    byId('ShowReport').innerHTML='<table class="table table-bordered"><thead><tr>'+h+c.join('')+'</thead><tbody id="rbody" style="display:none;">'+rbody+'</body></table>';
                    // A list of columns available to add to the report
                    h=colListTemplate.replace(/:id:/g,'')
                                    .replace(':val:',t9n('[RU]выберите таблицу[EN]Select table'));
                    var suffix;
                    for(i in json[b].rep_col_list){
                        if(json[b].rep_col_list[i].table===json[b].rep_col_list[i].id){
                            if(json[b].rep_col_list[parseInt(i)+1]&&json[b].rep_col_list[parseInt(i)+1].table===json[b].rep_col_list[i].id)
                                suffix='...';
                            else
                                suffix='';
                            h+=colListTemplate.replace(/:id:/g,json[b].rep_col_list[i].id)
                                            .replace(':val:',json[b].rep_col_list[i].name+suffix);
                        }
                        alias[json[b].rep_col_list[i].id]=json[b].rep_col_list[i].name.split(' -> ').pop();
                    }
                    $('#table').html(h);
                    // Request the report data
                    myApi('GET','report/{_global_.id}?LIMIT=25&JSON','ShowReport');
                    // Listeners to auto-save the changed control line values
                    $('.save-input').focusout(function(){ // Text input fields
                        updateValue(this);
                    });
                    $('.save-input').focusin(function(){ // Text input fields - get current element for Date DDs
                        curEl=this;
                    });
                    $('.onchange').change(function(){ // Dropdown lists
                        updateValue(this);
                    });
                    $('.save-input').keyup(function(){ // Text input fields on Enter pressed
                        if(event.keyCode==13)
                            updateValue(this);
                    });
                    colorBtns();
                }
                break;
            case 'ShowReport': // Construct the report table
                if(er!=''){ // There were errors during report retrieval
                    byId('warning').innerHTML=er.replace(/<A.+<\/a>/i,''); // Clean up the links if any
                    byId('warning').classList.remove('hidden');
                }
                else if(json[b]["data"]){
                    byId('warning').classList.add('hidden');
                    for(i in json[b]["data"][0]){ // Data lines
                        el=rbody;
                        for(j in json[b]["data"])
                            el=el.replace('>:'+j+':<','>'+json[b]["data"][j][i]+'<')
                                .replace(':align'+j+':',align(json[b]["columns"][j].format));
                        h+=el;
                    }
                    if(json[b]["columns"][0]["totals"]!==undefined){ // Fill in Total lines, if any
                        el=rbody;
                        for(j in json[b]["data"])
                            el=el.replace(':'+j+':','<b>'+json[b]["columns"][j]["totals"]+'</b>')
                                .replace(':align'+j+':',align(json[b]["columns"][j].format));
                        h+=el;
                    }
                    byId('rbody').innerHTML=h;
                    var id;
                    for(i in json[b]["columns"]) // Update DATE fields with keyword dropdowns
                        if(json[b]["columns"][i].format=='DATE')
                            if(dateDDFilledIn[json[b]["columns"][i].id]==undefined){
                                id=json[b]["columns"][i].id;
                    		    $('#t102_'+id).attr("data-toggle", "dropdown");
                    		    $('#t102_'+id).attr("autocomplete", "off");
                    		    $('#t103_'+id).attr("data-toggle", "dropdown");
                    		    $('#t103_'+id).attr("autocomplete", "off");
                    		    byId('dd102_'+id).innerHTML+=byId('date_dd').innerHTML.replace(/:t:/g,'102').replace(/:id:/g,id);
                                dateDDFilledIn[id]=true;
                            }
                }
                else{
                    byId('warning').innerHTML=t9n('[RU]Пустой отчет[EN]Empty report');
                    byId('warning').classList.remove('hidden');
                }
                $('#rbody').show();
                break;

        }
    }
}
var ordersCount;
function setOrder(id,dir,order){ // Set the order control
    ordersCount=0;
    for(i in json['select'].reqs)
        if(json['select'].reqs[i][109]!==undefined)
            if(order===''){ // Move others up in case we delete an order value
                if(Math.abs(json['select'].reqs[i][109])>json['select'].reqs[id][109])
                    myApi('POST','_m_set/'+i+'?JSON&a1&t109='+(parseInt(json['select'].reqs[i][109])-Math.sign(json['select'].reqs[i][109])),'setOrder','',ordersCount++);
            }
            else if((Math.abs(json['select'].reqs[i][109])<=order)||(dir===0)) // Move others down in case we add a new ordering
                myApi('POST','_m_set/'+i+'?JSON&a2&t109='+(Math.sign(json['select'].reqs[i][109])+parseInt(json['select'].reqs[i][109])),'setOrder','',ordersCount++);
    myApi('POST','_m_set/'+id+'?JSON&a3&t109='+order,'setOrder','',ordersCount++); // Save the initially changed order value
}
function colorBtns(){ // Color the buttons blue in case there are filled in control under them
    for(var i in ctl)
        byId(ctl[i]).classList.add('btn-outline-secondary');
    if(json['select'].reqs==undefined)
        return;
    for(i in json['select'].reqs)
        for(var j in json['select'].reqs[i])
            if(byId(k=j.replace('ref_',''))&&(json['select'].reqs[i][j]!=''))
                if(byId(k).classList.contains('btn-outline-secondary')){
                    byId(k).classList.remove('btn-outline-secondary');
                    byId(k).classList.add('btn-outline-primary');
                }
}
function updateValue(i){ // Save the updated control value
    var obj=i.id.split('_')[1],req=i.id.split('_')[0].substr(1);
    if(getReq(obj,req)==i.value)
        return;
    if($(i).attr('name')==='t101')
        if(['id','t','ord','up','val'].indexOf(i.value)!==-1)
            $(i).val(i.value.toUpperCase());
    setReq(obj,req,i.value);
    i.className+=' saving';
    myApi('POST','_m_set/'+obj+'?JSON&t'+req+'='+encodeURIComponent(i.value),'ctls','',i.id);
}
function setReq(id,t,v){ // Save the changed value in the local array
    if(json['select'].reqs==undefined)
        json['select'].reqs=[];
    if(json['select'].reqs[id]==undefined)
        json['select'].reqs[id]=[];
    json['select'].reqs[id][t]=v;
}
function d(d,i,v){ // Do the DML command and re-draw the report
    v=v||'';
    myApi('POST','_m_'+d+'/'+i+'?JSON&'+v,'d');
}
function drawCol(id){
    return '<a title="'+colOrigName(id)+'" onclick="activate('+id+')">'+colAlias(id)+'</a>';
}
function colAlias(id){ // In case the alias is not set, use the original object name, referenced by the column
    colNames[id]=getReq(id,100);
    if(colNames[id]==='')
        for(i in json['select'].object)
            if(json['select'].object[i].id==id)
                colNames[id]=json['select'].object[i].val;
    return colNames[id];
}
function colOrigName(id){ // The Object referenced by this column
    for(i in json['select'].object)
        if(json['select'].object[i].id==id)
            return json['select'].object[i].val;
}
function deActivate(id){ // Deactivate the column name edit field upon a focus change
    if(byId(id))
        byId(id).innerHTML=drawCol(id);
    active=undefined;
}
function activate(id){ // Activate the column name edit field upon click
    if(active==id)
        return;
    deActivate(active);
    active=id;
    // COnstruct the input field to edit the column name
    byId(id).innerHTML='<input type="text" id="c'+id+'" class="form-control form-control-sm" onkeyup="if(event.keyCode==13)updateCol(this)" onfocusout="updateCol(this);deActivate('+id+')" value="'+colAlias(id)+'">';
    byId('c'+id).focus();
}
function updateCol(i){ // Save the updated column name - alias
    var id=i.id.substr(1);
    if(colNames[id]==i.value)
        return;
    i.className+=' saving';
    setReq(id,100,i.value);
    colNames[id]=i.value;
    myApi('POST','_m_set/'+id+'?JSON&t100='+encodeURIComponent(i.value),'updateCol','',i.id);
}
function go(){ // Re-draw the header and the report
    byId('warning').classList.add('hidden');
    $('#rbody').hide();
    myApi('GET','edit_obj/{_global_.id}?JSON','one');
}
document.title=t9n('[RU]Конструктор запросов[EN]Query builder');
var rbody,active=-1,alias=[],colNames={},rep=[],json=[],colListTemplate=$('#table').html(),dateDDFilledIn=[],curEl,ctl=['102','84','104','109','72','101','105','132'];
if('{_global_.id}'=='')
    byId('showanchor').click();
else // In case a report is requested - draw it
    go();
</script>
